<!DOCTYPE html>  <html> <head>   <title>c_backend.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="ast.html">                 ast.js               </a>                                           <a class="source" href="c_backend.html">                 c_backend.js               </a>                                           <a class="source" href="parser.html">                 parser.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               c_backend.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">AST</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;ast&quot;</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">compile</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ast</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">functions</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="kd">var</span> <span class="nx">unique</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">++</span><span class="nx">i</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}();</span>

  <span class="kd">var</span> <span class="nx">quotes</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nx">s</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">statement</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">constructor</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>When we reach this place, we've already splitted var statements with assignment
into var statement and assignment statement.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">VarStatement</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">declarations</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">declaration</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="s2">&quot;binding = dict_insert(binding, &quot;</span> <span class="o">+</span>
            <span class="nx">quotes</span><span class="p">(</span><span class="nx">declaration</span><span class="p">.</span><span class="nx">identifier</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;, js_create_variable(js_new_undefined()));&quot;</span><span class="p">;</span>
        <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">ReturnStatement</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;return &quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">;</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">ExpressionStatement</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">;</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">IfStatement</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;if (js_is_truthy(&quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">condition</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;))&quot;</span> <span class="o">+</span>
          <span class="s2">&quot;{ &quot;</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">whenTruthy</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">statement</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; } &quot;</span> <span class="o">+</span>
          <span class="s2">&quot;else { &quot;</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">whenFalsy</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">statement</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; }&quot;</span><span class="p">;</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">ForStatement</span><span class="o">:</span>
        <span class="k">return</span> <span class="p">[</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">initial</span><span class="p">(),</span>
          <span class="nx">AST</span><span class="p">.</span><span class="nx">WhileStatement</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">condition</span><span class="p">(),</span> <span class="nx">node</span><span class="p">.</span><span class="nx">statements</span><span class="p">().</span><span class="nx">concat</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">finalize</span><span class="p">()))</span>
        <span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nx">statement</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">ForInStatement</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;JSValue* object = js_to_object(env, &quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">object</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;);\n&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Dict property = NULL;\n&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;if (object-&gt;object_value) property = object-&gt;object_value-&gt;properties;\n&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;while (object &amp;&amp; object-&gt;object_value &amp;&amp; property) {\n&quot;</span><span class="o">+</span>
              <span class="s2">&quot;js_assign_variable(env, binding, &quot;</span> <span class="o">+</span> <span class="nx">quotes</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">identifier</span><span class="p">())</span> <span class="o">+</span>
                <span class="s2">&quot;, js_new_string(property-&gt;key));\n&quot;</span> <span class="o">+</span>
              <span class="nx">node</span><span class="p">.</span><span class="nx">statements</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">statement</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span>
              <span class="s2">&quot;property = property-&gt;next;\n&quot;</span> <span class="o">+</span>
              <span class="s2">&quot;if (property == NULL) { object = object-&gt;object_value-&gt;prototype; if (object) { property = object-&gt;object_value-&gt;properties; } };\n&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;}&quot;</span> <span class="o">+</span>
          <span class="s2">&quot;}&quot;</span><span class="p">;</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">WhileStatement</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;while (js_is_truthy(&quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">condition</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;))&quot;</span> <span class="o">+</span>
          <span class="s2">&quot;{ &quot;</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">statements</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">statement</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; }; &quot;</span><span class="p">;</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">TryStatement</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">tryStatement</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">ThrowStatement</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;js_throw(env, &quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;);&quot;</span><span class="p">;</span>

      <span class="k">default</span><span class="o">:</span>
        <span class="k">throw</span> <span class="s2">&quot;Incorrect AST&quot;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">tryStatement</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">toCFunction</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">statements</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;JSValue* &quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;(JSEnv* env, JSValue* this, Dict binding) {\n&quot;</span> <span class="o">+</span>
        <span class="nx">statements</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">statement</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">)</span> <span class="o">+</span>
        <span class="s2">&quot;return NULL;\n&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;}&quot;</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">tryFunc</span> <span class="o">=</span> <span class="s2">&quot;try_&quot;</span> <span class="o">+</span> <span class="nx">unique</span><span class="p">();</span>
    <span class="nx">functions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">toCFunction</span><span class="p">(</span><span class="nx">tryFunc</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">tryStatements</span><span class="p">()));</span>

    <span class="kd">var</span> <span class="nx">catchFunc</span> <span class="o">=</span> <span class="s2">&quot;catch_&quot;</span> <span class="o">+</span> <span class="nx">unique</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">catchStatements</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">catchStatements</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">catchIdentifier</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">identifier</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">catchIdentifier</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">catchStatements</span> <span class="o">=</span> <span class="p">[</span><span class="nx">AST</span><span class="p">.</span><span class="nx">ThrowStatement</span><span class="p">(</span><span class="nx">AST</span><span class="p">.</span><span class="nx">Variable</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">))];</span>
      <span class="nx">catchIdentifier</span> <span class="o">=</span> <span class="s2">&quot;e&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">functions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">toCFunction</span><span class="p">(</span><span class="nx">catchFunc</span><span class="p">,</span> <span class="nx">catchStatements</span><span class="p">));</span>

    <span class="kd">var</span> <span class="nx">finallyFunc</span> <span class="o">=</span> <span class="s2">&quot;finally_&quot;</span> <span class="o">+</span> <span class="nx">unique</span><span class="p">();</span>
    <span class="nx">functions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">toCFunction</span><span class="p">(</span><span class="nx">finallyFunc</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">finallyStatements</span><span class="p">()));</span>

    <span class="k">return</span> <span class="s2">&quot;{\n&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;JSException* exc = js_push_new_exception(env);\n&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;if (!setjmp(exc-&gt;jmp)) { &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;JSValue* ret = &quot;</span> <span class="o">+</span> <span class="nx">tryFunc</span> <span class="o">+</span> <span class="s2">&quot;(env, this, binding);\n&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;js_pop_exception(env);\n&quot;</span> <span class="o">+</span>
        <span class="nx">finallyFunc</span> <span class="o">+</span> <span class="s2">&quot;(env, this, binding);\n&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;if (ret) return ret;\n&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;} else {\n&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;JSVariable exc_variable = js_create_variable((JSValue *) exc-&gt;value);\n&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;js_pop_exception(env);\n&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;JSValue* ret = &quot;</span> <span class="o">+</span> <span class="nx">catchFunc</span> <span class="o">+</span> <span class="s2">&quot;(env, this, dict_insert(binding, &quot;</span> <span class="o">+</span>
          <span class="nx">quotes</span><span class="p">(</span><span class="nx">catchIdentifier</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, exc_variable));\n&quot;</span> <span class="o">+</span>
        <span class="nx">finallyFunc</span> <span class="o">+</span> <span class="s2">&quot;(env, this, binding);\n&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;if (ret) return ret;\n&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;}\n}\n&quot;</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">escapeCString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">replace</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">p</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">str</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="s2">&quot;\\&quot;</span><span class="p">,</span> <span class="s2">&quot;\\\\&quot;</span><span class="p">);</span>
    <span class="nx">str</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="s2">&quot;\&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;\\\&quot;&quot;</span><span class="p">);</span>
    <span class="nx">str</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="s2">&quot;\n&quot;</span><span class="p">,</span> <span class="s2">&quot;\\n&quot;</span><span class="p">);</span>
    <span class="nx">str</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="s2">&quot;\t&quot;</span><span class="p">,</span> <span class="s2">&quot;\\t&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">str</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">constructor</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">NumberLiteral</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;js_new_number(&quot;</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">number</span><span class="p">().</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">StringLiteral</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;js_new_string(&quot;</span> <span class="o">+</span> <span class="nx">quotes</span><span class="p">(</span><span class="nx">escapeCString</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">string</span><span class="p">()))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">BooleanLiteral</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">value</span><span class="p">())</span> <span class="p">{</span>
          <span class="k">return</span> <span class="s2">&quot;js_new_boolean(1)&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="s2">&quot;js_new_boolean(0)&quot;</span><span class="p">;</span>
        <span class="p">}</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">ObjectLiteral</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">objectLiteral</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">ArrayLiteral</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">arrayLiteral</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">FunctionLiteral</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">functionLiteral</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">functions</span><span class="p">);</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">UndefinedLiteral</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;js_new_undefined()&quot;</span><span class="p">;</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">NullLiteral</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;js_new_null()&quot;</span><span class="p">;</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">Variable</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;js_get_variable_rvalue(env, binding, &quot;</span> <span class="o">+</span> <span class="nx">quotes</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">identifier</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">ThisVariable</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;this&quot;</span><span class="p">;</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">Refinement</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;js_get_property(env, &quot;</span> <span class="o">+</span>
          <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span>
          <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">key</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">Invocation</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">invocation</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">BinaryOp</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">binaryOp</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">UnaryOp</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">unaryOp</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">PostIncrement</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">AST</span><span class="p">.</span><span class="nx">BinaryOp</span><span class="p">(</span><span class="s2">&quot;+=&quot;</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">(),</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">NumberLiteral</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">PostDecrement</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">AST</span><span class="p">.</span><span class="nx">BinaryOp</span><span class="p">(</span><span class="s2">&quot;-=&quot;</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">(),</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">NumberLiteral</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span>

      <span class="k">case</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">Comma</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">expressions</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">expression</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>

      <span class="k">default</span><span class="o">:</span>
        <span class="k">throw</span> <span class="s2">&quot;Incorrect AST&quot;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">objectLiteral</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;js_new_object(env, &quot;</span> <span class="o">+</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">pairs</span><span class="p">().</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">acc</span><span class="p">,</span> <span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;dict_insert(&quot;</span> <span class="o">+</span> <span class="nx">acc</span> <span class="o">+</span> <span class="s2">&quot;, \&quot;&quot;</span> <span class="o">+</span> <span class="nx">property</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;\&quot;, &quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">property</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
      <span class="p">},</span> <span class="s2">&quot;dict_create()&quot;</span><span class="p">)</span> <span class="o">+</span>
    <span class="s2">&quot;)&quot;</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">arrayLiteral</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">AST</span><span class="p">.</span><span class="nx">UnaryOp</span><span class="p">(</span><span class="s2">&quot;new&quot;</span><span class="p">,</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">Invocation</span><span class="p">(</span><span class="nx">AST</span><span class="p">.</span><span class="nx">Variable</span><span class="p">(</span><span class="s2">&quot;Array&quot;</span><span class="p">),</span> <span class="nx">node</span><span class="p">.</span><span class="nx">items</span><span class="p">())));</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Utility function to create C list from array of strings</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">toCList</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">array</span><span class="p">.</span><span class="nx">reduceRight</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">acc</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;list_insert(&quot;</span> <span class="o">+</span> <span class="nx">acc</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nx">item</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
    <span class="p">},</span> <span class="s2">&quot;list_create()&quot;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">functionLiteral</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;fun_&quot;</span> <span class="o">+</span> <span class="nx">unique</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">reorderVarStatements</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">statements</span><span class="p">()).</span><span class="nx">map</span><span class="p">(</span><span class="nx">statement</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">argNames</span> <span class="o">=</span> <span class="nx">toCList</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">args</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nx">a</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span> <span class="p">}));</span>
    <span class="kd">var</span> <span class="nx">buildArgumentsObject</span> <span class="o">=</span> <span class="s2">&quot;binding = dict_insert(binding, \&quot;arguments\&quot;, js_create_variable(&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;js_invoke_constructor(env, &quot;</span><span class="o">+</span>
        <span class="s2">&quot;js_get_property(env, env-&gt;global, js_new_string(\&quot;Array\&quot;)), &quot;</span><span class="o">+</span>
        <span class="s2">&quot;argValues)&quot;</span><span class="o">+</span>
      <span class="s2">&quot;));&quot;</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">cFunction</span> <span class="o">=</span>
      <span class="s2">&quot;JSValue* &quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;(JSEnv* env, JSValue* this, List argValues, Dict binding) {\n&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;List argNames = &quot;</span> <span class="o">+</span> <span class="nx">argNames</span> <span class="o">+</span> <span class="s2">&quot;;\n&quot;</span> <span class="o">+</span>
        <span class="nx">buildArgumentsObject</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;binding = js_append_args_to_binding(argNames, argValues, binding);\n&quot;</span> <span class="o">+</span>
        <span class="nx">body</span> <span class="o">+</span>
        <span class="s2">&quot;return js_new_undefined();\n&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;}\n&quot;</span><span class="p">;</span>
    <span class="nx">functions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cFunction</span><span class="p">);</span>
    <span class="k">return</span> <span class="s2">&quot;js_new_function(env, &amp;&quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;, binding)&quot;</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Traverse list of nodes and move all var statements to the top.
When var statement also assigns value, create new assign statement,
but still move variable declaration to the top.
Please note this function will modify the tree in-place.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">reorderVarStatements</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">nodes</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">identifiers</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="kd">var</span> <span class="nx">visit</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">nodes</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">assignments</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="kd">var</span> <span class="nx">convertVarStatement</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">declarations</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">declaration</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">identifiers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">declaration</span><span class="p">.</span><span class="nx">identifier</span><span class="p">());</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">declaration</span> <span class="k">instanceof</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">VarWithValueDeclaration</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">assignments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
                <span class="nx">AST</span><span class="p">.</span><span class="nx">BinaryOp</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">Variable</span><span class="p">(</span><span class="nx">declaration</span><span class="p">.</span><span class="nx">identifier</span><span class="p">()),</span> <span class="nx">declaration</span><span class="p">.</span><span class="nx">expression</span><span class="p">()));</span>
            <span class="p">}</span>
          <span class="p">});</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">assignments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">ExpressionStatement</span><span class="p">(</span><span class="nx">AST</span><span class="p">.</span><span class="nx">Comma</span><span class="p">(</span><span class="nx">assignments</span><span class="p">));</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">};</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">VarStatement</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">convertVarStatement</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">IfStatement</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">visit</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">whenTruthy</span><span class="p">());</span>
          <span class="nx">visit</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">whenFalsy</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">ForStatement</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">initial</span><span class="p">()</span> <span class="k">instanceof</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">VarStatement</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">ForStatement</span><span class="p">(</span>
              <span class="nx">convertVarStatement</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">initial</span><span class="p">()),</span>
              <span class="nx">node</span><span class="p">.</span><span class="nx">condition</span><span class="p">(),</span>
              <span class="nx">node</span><span class="p">.</span><span class="nx">finalize</span><span class="p">(),</span>
              <span class="nx">node</span><span class="p">.</span><span class="nx">statements</span><span class="p">()</span>
            <span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">visit</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">statements</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">TryStatement</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">visit</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">tryStatements</span><span class="p">());</span>
          <span class="nx">visit</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">catchStatements</span><span class="p">());</span>
          <span class="nx">visit</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">finallyStatements</span><span class="p">());</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
    <span class="nx">visit</span><span class="p">(</span><span class="nx">nodes</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>A utility function that modifies array and puts items before existing array items.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">prepend</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">items</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">splice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">items</span><span class="p">));</span>
    <span class="p">};</span>

    <span class="nx">prepend</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">VarStatement</span><span class="p">(</span><span class="nx">identifiers</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">AST</span><span class="p">.</span><span class="nx">VarDeclaration</span><span class="p">)));</span>
    <span class="k">return</span> <span class="nx">nodes</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">invocation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">argValues</span> <span class="o">=</span> <span class="nx">toCList</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">args</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">expression</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">()</span> <span class="k">instanceof</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">Refinement</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">().</span><span class="nx">expression</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">().</span><span class="nx">key</span><span class="p">();</span>
      <span class="k">return</span> <span class="s2">&quot;js_call_method(env, &quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span>
        <span class="nx">expression</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nx">argValues</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;js_call_function(env, &quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;, env-&gt;global, &quot;</span> <span class="o">+</span> <span class="nx">argValues</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">binaryOp</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">operatorFunctions</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;+&quot;</span><span class="o">:</span> <span class="s2">&quot;js_add&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="o">:</span> <span class="s2">&quot;js_sub&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="o">:</span> <span class="s2">&quot;js_mult&quot;</span><span class="p">,</span>
      <span class="s2">&quot;&lt;&quot;</span><span class="o">:</span> <span class="s2">&quot;js_lt&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="o">:</span> <span class="s2">&quot;js_gt&quot;</span><span class="p">,</span>
      <span class="s2">&quot;==&quot;</span><span class="o">:</span> <span class="s2">&quot;js_eq&quot;</span><span class="p">,</span> <span class="s2">&quot;!=&quot;</span><span class="o">:</span> <span class="s2">&quot;js_neq&quot;</span><span class="p">,</span>
      <span class="s2">&quot;===&quot;</span><span class="o">:</span> <span class="s2">&quot;js_strict_eq&quot;</span><span class="p">,</span> <span class="s2">&quot;!==&quot;</span><span class="o">:</span> <span class="s2">&quot;js_strict_neq&quot;</span><span class="p">,</span>
      <span class="s2">&quot;&amp;&quot;</span><span class="o">:</span> <span class="s2">&quot;js_binary_and&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="o">:</span> <span class="s2">&quot;js_binary_xor&quot;</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="o">:</span> <span class="s2">&quot;js_binary_or&quot;</span><span class="p">,</span>
      <span class="s2">&quot;&amp;&amp;&quot;</span><span class="o">:</span> <span class="s2">&quot;js_logical_and&quot;</span><span class="p">,</span> <span class="s2">&quot;||&quot;</span><span class="o">:</span> <span class="s2">&quot;js_logical_or&quot;</span><span class="p">,</span>
      <span class="s2">&quot;instanceof&quot;</span><span class="o">:</span> <span class="s2">&quot;js_instanceof&quot;</span>
    <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">assignOperators</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;+=&quot;</span><span class="p">,</span> <span class="s2">&quot;-=&quot;</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">operator</span><span class="p">()</span> <span class="o">===</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">leftExpr</span><span class="p">()</span> <span class="k">instanceof</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">Variable</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;js_assign_variable(env, binding, &quot;</span> <span class="o">+</span>
          <span class="nx">quotes</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">leftExpr</span><span class="p">().</span><span class="nx">identifier</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span>
          <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">rightExpr</span><span class="p">())</span> <span class="o">+</span>
        <span class="s2">&quot;)&quot;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">leftExpr</span><span class="p">()</span> <span class="k">instanceof</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">Refinement</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;js_set_object_property(env, &quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">leftExpr</span><span class="p">().</span><span class="nx">expression</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span>
          <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">leftExpr</span><span class="p">().</span><span class="nx">key</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">rightExpr</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="s2">&quot;Invalid left-hand side in assignment&quot;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">assignOperators</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">operator</span><span class="p">())</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">expression</span><span class="p">(</span>
        <span class="nx">AST</span><span class="p">.</span><span class="nx">BinaryOp</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">leftExpr</span><span class="p">(),</span>
          <span class="nx">AST</span><span class="p">.</span><span class="nx">BinaryOp</span><span class="p">(</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">operator</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">leftExpr</span><span class="p">(),</span> <span class="nx">node</span><span class="p">.</span><span class="nx">rightExpr</span><span class="p">()</span>
        <span class="p">))</span>
      <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">operatorFunctions</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">operator</span><span class="p">()]</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="s2">&quot;Unsupported operator: &quot;</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">operator</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">operatorFunctions</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">operator</span><span class="p">()]</span> <span class="o">+</span> <span class="s2">&quot;(env, &quot;</span> <span class="o">+</span>
      <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">leftExpr</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">rightExpr</span><span class="p">())</span>  <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">unaryOp</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">operator</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s2">&quot;new&quot;</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">newExpression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">());</span>

      <span class="k">case</span> <span class="s2">&quot;typeof&quot;</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;js_typeof(&quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>

      <span class="k">case</span> <span class="s2">&quot;!&quot;</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;js_new_boolean(! js_to_boolean(&quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;)-&gt;boolean_value)&quot;</span><span class="p">;</span>

      <span class="k">case</span> <span class="s2">&quot;+&quot;</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;js_new_number(js_to_number(&quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;)-&gt;number_value)&quot;</span><span class="p">;</span>

      <span class="k">case</span> <span class="s2">&quot;-&quot;</span><span class="o">:</span>
        <span class="k">return</span> <span class="s2">&quot;js_new_number(-1 * js_to_number(&quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;)-&gt;number_value)&quot;</span><span class="p">;</span>

      <span class="k">default</span><span class="o">:</span>
        <span class="k">throw</span> <span class="s2">&quot;Unsupported operator: &quot;</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">operator</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">newExpression</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fun</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">argValues</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">Invocation</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fun</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">expression</span><span class="p">();</span>
      <span class="nx">argValues</span> <span class="o">=</span> <span class="nx">toCList</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">args</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">expression</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">fun</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
      <span class="nx">argValues</span> <span class="o">=</span> <span class="s2">&quot;NULL&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s2">&quot;js_invoke_constructor(env, &quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">(</span><span class="nx">fun</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">argValues</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">addTemplate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">program</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span>
      <span class="s1">&#39;#include &lt;stdio.h&gt;\n&#39;</span> <span class="o">+</span>
      <span class="s1">&#39;#include &quot;src/js.c&quot;\n&#39;</span> <span class="o">+</span>
      <span class="nx">functions</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span> <span class="o">+</span>
      <span class="s1">&#39;int main() {\n&#39;</span> <span class="o">+</span>
      <span class="s1">&#39;  JSEnv* env = malloc(sizeof(JSEnv));\n&#39;</span> <span class="o">+</span>
      <span class="s1">&#39;  env-&gt;exceptions_count = 0;\n&#39;</span> <span class="o">+</span>
      <span class="s1">&#39;  env-&gt;global = js_new_bare_object();\n&#39;</span> <span class="o">+</span>
      <span class="s1">&#39;  js_create_native_objects(env);\n&#39;</span> <span class="o">+</span>
      <span class="s1">&#39;  Dict binding = dict_create();\n&#39;</span> <span class="o">+</span>
      <span class="s1">&#39;  js_dump_value(&#39;</span> <span class="o">+</span> <span class="nx">program</span> <span class="o">+</span> <span class="s1">&#39;);\n&#39;</span> <span class="o">+</span>
      <span class="s1">&#39;  return 0;\n&#39;</span> <span class="o">+</span>
      <span class="s1">&#39;}\n&#39;</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Wrap program statements in try {} block and anonymous function invocation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">program</span> <span class="o">=</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">Invocation</span><span class="p">(</span><span class="nx">AST</span><span class="p">.</span><span class="nx">FunctionLiteral</span><span class="p">([],</span>
    <span class="p">[</span><span class="nx">AST</span><span class="p">.</span><span class="nx">TryStatement</span><span class="p">(</span>
      <span class="nx">ast</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span>
      <span class="p">[</span><span class="nx">AST</span><span class="p">.</span><span class="nx">ExpressionStatement</span><span class="p">(</span>
        <span class="nx">AST</span><span class="p">.</span><span class="nx">Invocation</span><span class="p">(</span>
          <span class="nx">AST</span><span class="p">.</span><span class="nx">Refinement</span><span class="p">(</span><span class="nx">AST</span><span class="p">.</span><span class="nx">Variable</span><span class="p">(</span><span class="s2">&quot;console&quot;</span><span class="p">),</span> <span class="nx">AST</span><span class="p">.</span><span class="nx">StringLiteral</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)),</span>
          <span class="p">[</span><span class="nx">AST</span><span class="p">.</span><span class="nx">Variable</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">)]</span>
        <span class="p">)</span>
      <span class="p">)],</span> <span class="p">[]</span>
    <span class="p">)]</span>
  <span class="p">),</span> <span class="p">[]);</span>

  <span class="k">return</span> <span class="nx">addTemplate</span><span class="p">(</span><span class="nx">expression</span><span class="p">(</span><span class="nx">program</span><span class="p">));</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 